<!DOCTYPE html>
<html lang="fr" translate="no">

<head>
    <meta charset="UTF-8">
    <title>GLAD Alerts ‚Äì Idjwi</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        @font-face {
            font-family: 'Karla-Cedille';
            src: url('assets/fonts/Cedille.woff2') format('woff2');
            font-style: normal;
            font-weight: 500;
        }

        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Karla-Cedille', sans-serif;
            color: #213547;
            width: 100%;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100vh;
            background: #fff;
            font-optical-sizing: auto;
            line-height: 1.2;
            font-size: 1rem;
            font-weight: 400;
            font-synthesis: none;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
        }

        /* MAP */
        #map {
            flex: 1 1 auto;
            width: 100%;
            min-height: 0;
            height: 100%;
        }

        .leaflet-container {
            width: 100% !important;
            height: 100% !important;
        }

        /* FOOTER */
        #footer {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            background: #fff;
            color: #213547;
            border-top: 1px solid #21354720;
            background-image: url('assets/orchard-_ppFX2in.svg');
            background-size: 100px 100px;
            box-sizing: border-box;
        }

        #footer h1 {
            font-size: 1.3rem;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        #info-btn {
            background: none;
            border: #213547 1px solid;
            padding: 10px 18px;
            border-radius: 6px;
            font-size: 1.1rem;
            color: #213547;
            font-family: 'Karla-Cedille';
            cursor: pointer;
            transition: background 0.3s ease;
        }

        #info-btn:hover {
            background: red;
            color: #fff;
            border: none;
        }

        .leaflet-control-timebar {
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            font-family: 'Karla-Cedille';
            font-size: 1.1rem;
            color: #213547;
            width: 240px;
        }

        .timebar-bar,
        #footer {
            flex-shrink: 0;
        }

        .timebar-bar {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 1rem;
            box-sizing: border-box;
            background: #fff;
            border-top: 1px solid #21354720;
            border-bottom: 1px solid #21354720;
        }

        .timebar-label {
            text-align: center;
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 1.2rem;
        }

        .timebar-slider {
            width: 100%;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            align-items: center;
            justify-content: center;
            outline: 1px solid #213547 !important;
            outline-offset: 5px;
        }

        .modal-content {
            background: #fff;
            color: #213547;
            background-image: url('assets/orchard-_ppFX2in.svg');
            background-size: 100px 100px;
            padding: 30px;
            border-radius: 5px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            font-family: 'Karla-Cedille';
            max-height: 80%;
            overflow: auto;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #213547;
        }

        .modal-content p {
            line-height: 1.3;
            font-size: 1.1rem;
        }

        .descr p {
            font-size: 1rem !important;
        }

        .close-btn {
            margin-top: 20px;
            background: #202020;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Karla-Cedille';
        }

        .close-btn:hover {
            background: #444;
        }

        .copy-btn {
            font-family: 'Karla-Cedille', sans-serif;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1.1rem;
            margin-left: 4px;
            color: #fff;
        }

        #copy-message {
            font-family: 'Karla-Cedille', sans-serif;
            font-size: 1.1rem;
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 6px 12px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 9999;
            pointer-events: none;
        }

        .leaflet-container {
            background: #ffffff !important;
        }

        .leaflet-control-attribution,
        .leaflet-popup-tip {
            display: none;
        }

        .leaflet-popup {
            font-family: 'Karla-Cedille', sans-serif;
        }

        .copied-popup .leaflet-popup-content-wrapper {
            background: #333;
            color: #fff;
            font-size: 1.1rem;
            padding: 2px 6px;
            border-radius: 4px;
        }

        #timebar {
            margin-bottom: 10px !important;
            background-image: url('assets/orchard-_ppFX2in.svg');
            background-size: 100px 100px;
            background-color: #fff;

        }

        .timebar-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            background: rgba(255, 255, 255, 0.95);
            padding: 6px 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            font-family: 'Karla-Cedille';
            font-size: 1.1rem;
            color: #213547;
        }

        .timebar-bar input[type="date"] {
            padding: 3px 6px;
            border: 1px solid #213547;
            border-radius: 4px;
            font-family: 'Karla-Cedille';
        }

        .timebar-bar button {
            padding: 5px 10px;
            font-family: 'Karla-Cedille';
            border: 1px solid #213547;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
        }

        .timebar-bar button:hover {
            background: red;
            color: #fff;
        }

        .timebar-slider {
            font-family: 'Karla-Cedille' !important;
        }

        .flatpickr-calendar {
            font-family: 'Karla-Cedille' !important;
            border-radius: 8px !important;
            border: 1px solid #21354740 !important;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0) !important;
        }

        .flatpickr-month {
            background-image: url('assets/orchard-_ppFX2in.svg') !important;
            background-size: 100px 100px !important;
        }

        .flatpickr-day.today {
            border-color: red !important;
            color: red !important;
        }

        .flatpickr-day.selected {
            background: red !important;
            border-color: red !important;
            color: #fff !important;
        }

        .flatpickr-months,
        .flatpickr-weekdays {
            background: #fff !important;
            color: #213547 !important;
        }

        .flatpickr-day:hover {
            background: rgba(255, 0, 0, 0.1) !important;
            color: red !important;
        }

        @media (max-width: 480px) {

            html,
            body {
                height: 100vh;
                overflow: hidden;
            }

            #map {
                height: 80vh;
            }

            .modal-content {
                width: 80vw;
            }

            #footer {
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 1rem;
                gap: 0.5rem;
                width: 100%;
                box-sizing: border-box;
                height: 20vh;
            }

            #footer h1 {
                font-size: 1.5rem;
                text-align: center;
                margin: 0;
                white-space: normal;
            }
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <div id="copy-message">Coordonn√©es copi√©es !</div>

    <div class="timebar-bar">
        <label for="start-date">De:</label>
        <input type="date" id="start-date" lang="fr" class="timebar-slider">

        <label for="end-date">√Ä:</label>
        <input type="date" id="end-date" lang="fr" class="timebar-slider">

        <button id="apply-filter">Filtrer</button>
    </div>


    <div id="footer">
        <h1>Syst√®me d'alerte de d√©forestation de l'√Æle d'Idjwi</h1>
        <button id="info-btn">Pourquoi l'utiliser ?</button>
    </div>

    <div id="info-modal" class="modal">
        <div class="modal-content">
            <h2>Pourquoi utiliser le syst√®me d'alerte de d√©forestation de l'√Æle d'Idjwi</h2>
            <p>
                L'√Æle d'Idjwi est consid√©r√©e comme l'√Æle de la paix entre les lignes ennemies. Dans un conflit qui dure
                depuis des d√©cennies, elle n'a jamais √©t√© le th√©√¢tre de batailles, devenant ainsi le seul site naturel
                sacr√© s√©curis√© parmi toutes les communaut√©s qui bordent le lac Kivu.
            </p>
            <p>
                Suite aux premi√®res inqui√©tudes exprim√©es par les communaut√©s vivant sur l'√Æle concernant une r√©cente
                exploitation d√©s√©quilibr√©e des ressources naturelles et foresti√®res, due √† une nouvelle vague
                d'extractivisme impliquant √©galement des acteurs √©trangers, nous avons mis en place ce syst√®me d'alerte
                destin√© aux habitants, afin qu'ils puissent surveiller l'√Æle et veiller √† ce qu'elle reste le site
                naturel sacr√© et s√©curis√© qui a fait sa renomm√©e.
            </p>
            <div class="descr" style="margin-top: 3rem;">
                <p><u>Comment √ßa marche</u></p>
                <p>
                    Ce syst√®me d'alerte met √† jour la carte des alertes tous les 10 jours et, √† son ouverture, elle
                    affiche la localisation de la derni√®re alerte. Les coordonn√©es des alertes peuvent √™tre facilement
                    copi√©es afin
                    d'√™tre transmises aux appareils et applications cartographiques qui utilisent le GPS pour donner des
                    directions.
                </p>
                <p>
                    Les alertes sont obtenues en analysant les donn√©es du ¬´ GLAD Landsat alert system ¬ª, √† partir du 1er
                    janvier 2025.<br>Chaque alerte GLAD indique une zone de 30 m√®tres sur 30 m√®tres qui a
                    subi une perturbation dans la canop√©e foresti√®re, ce qui signifie que les arbres de cette zone ont
                    peut-√™tre √©t√© perdus ou supprim√©s. Ainsi, chaque alerte correspond √† une d√©forestation potentielle,
                    <u>mais pas n√©cessairement due √† une action anthropique ou ill√©gale</u>. Les alertes ont pour but de
                    fournir une indication pr√©coce des endroits o√π une nouvelle d√©forestation pourrait avoir lieu, afin
                    que les forces de l'ordre, les communaut√©s, le leadership coutumier, les organisations militantes et
                    les autres
                    acteurs puissent prendre des mesures cibl√©es.
                </p>
                <p style="color: #aaa9a9;">
                    Citation:<br>Hansen, Matthew C., Alexander Krylov, Alexandra Tyukavina, Peter V. Potapov, Svetlana
                    Turubanova,
                    Bryan Zutta, Suspense Ifo, Belinda Margono, Fred Stolle, and Rebecca Moore. ‚ÄúHumid Tropical Forest
                    Disturbance Alerts Using Landsat Data.‚Äù Environmental Research Letters 11, no. 3 (2016): 034008.
                </p>
            </div>
            <button class="close-btn" id="close-modal">Fermer</button>
        </div>
    </div>


    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <!-- Flatpickr -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/fr.js"></script>

    <script>
        (() => {
            // -----------------------------
            // 1Ô∏è‚É£ Modal Logic
            // -----------------------------
            const infoBtn = document.getElementById('info-btn');
            const modal = document.getElementById('info-modal');
            const closeModal = document.getElementById('close-modal');

            infoBtn.addEventListener('click', () => modal.style.display = 'flex');
            closeModal.addEventListener('click', () => modal.style.display = 'none');
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.style.display = 'none';
            });

            window.showCopyMessage = function () {
                const msg = document.getElementById("copy-message");
                msg.style.opacity = 1;
                setTimeout(() => { msg.style.opacity = 0; }, 1000);
            };

            // -----------------------------
            // 2Ô∏è‚É£ Initialize App
            // -----------------------------
            window.onload = async function () {
                try {
                    // Supabase setup
                    const supabaseUrl = 'https://sgjcevsavckwsjplzned.supabase.co';
                    const supabaseKey =
                        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnamNldnNhdmNrd3NqcGx6bmVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMjMyOTgsImV4cCI6MjA3NTc5OTI5OH0.eeUvKqddDTk7G1MBzQPhoNB15NIpFIrvKk90PAOYbQQ';
                    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

                    // Map setup
                    const mapBounds = L.latLngBounds([-2.3293, 28.9075], [-1.8339, 29.207]);
                    const map = L.map('map', {
                        minZoom: 10,
                        maxZoom: 16,
                        maxBounds: mapBounds
                    }).setView([-2.1, 29.05], 11);

                    L.tileLayer(
                        "https://www.alessandromusetta.com/geo/tiles/minimapidjwi/{z}/{x}/{y}.png",
                        { minZoom: 8, maxZoom: 12, noWrap: true, attribution: "" }
                    ).addTo(map);

                    L.tileLayer(
                        "https://www.alessandromusetta.com/geo/tiles/idjwi/{z}/{x}/{y}.jpg",
                        { minZoom: 13, maxZoom: 16, noWrap: true, attribution: "" }
                    ).addTo(map);

                    // Fetch alerts
                    const { data, error } = await supabaseClient
                        .from('alerts')
                        .select('geom, alert_value, alert_date');

                    if (error) throw error;
                    if (!data || data.length === 0) {
                        console.warn("‚ö†Ô∏è No alerts found in database.");
                        return;
                    }

                    let allAlerts = data.filter(a => a.alert_date);
                    allAlerts.sort((a, b) => new Date(a.alert_date) - new Date(b.alert_date));

                    // Setup date pickers with Flatpickr
                    const startInput = document.getElementById('start-date');
                    const endInput = document.getElementById('end-date');

                    const oldest = new Date(allAlerts[0].alert_date);
                    const newest = new Date(allAlerts[allAlerts.length - 1].alert_date);
                    const toInputDate = d => d.toISOString().split('T')[0];

                    const flatpickrOptions = {
                        locale: 'fr',
                        dateFormat: "Y-m-d",
                        altInput: true,
                        altFormat: "d-m-Y",
                        theme: 'default',
                        onChange: function (selectedDates, dateStr) {
                            console.log("üìÖ Selected:", dateStr);
                        }
                    };

                    const fpStart = flatpickr(startInput, {
                        ...flatpickrOptions,
                        defaultDate: toInputDate(oldest),
                        minDate: toInputDate(oldest),
                        maxDate: toInputDate(newest)
                    });

                    const fpEnd = flatpickr(endInput, {
                        ...flatpickrOptions,
                        defaultDate: toInputDate(newest),
                        minDate: toInputDate(oldest),
                        maxDate: toInputDate(newest)
                    });

                    // -----------------------------
                    // 3Ô∏è‚É£ Rendering Alerts
                    // -----------------------------
                    function renderAlerts(alerts) {
                        map.eachLayer(layer => {
                            if (layer instanceof L.Rectangle || layer instanceof L.Circle || layer instanceof L.Marker) {
                                if (!layer._url) map.removeLayer(layer);
                            }
                        });

                        const visibleAlerts = alerts.filter(a => {
                            if (!a.geom?.coordinates) return false;
                            const [lon, lat] = a.geom.coordinates;
                            return mapBounds.contains([lat, lon]);
                        }).sort((a, b) => new Date(b.alert_date) - new Date(a.alert_date));

                        const latest = visibleAlerts[0];
                        const second = visibleAlerts[1];
                        const halfSideDeg = 0.000135;
                        const circleRadius = 120;

                        visibleAlerts.forEach(alert => {
                            const [lon, lat] = alert.geom.coordinates;
                            const alertDate = new Date(alert.alert_date);
                            const formatted = alertDate.toLocaleDateString('fr-FR', {
                                day: '2-digit', month: '2-digit', year: 'numeric'
                            });

                            let color = 'red', weight = 1, fillOpacity = 0.6;
                            if (alert === latest) { weight = 2; fillOpacity = 0.9; }
                            else if (alert === second) { weight = 2; fillOpacity = 0.8; }

                            L.rectangle([[lat - halfSideDeg, lon - halfSideDeg], [lat + halfSideDeg, lon + halfSideDeg]],
                                { color, weight, fillColor: color, fillOpacity }
                            ).addTo(map);

                            L.circle([lat, lon], {
                                radius: circleRadius, color, weight: 1.5, opacity: 0.5, fill: false
                            }).addTo(map);

                            if (alert === latest || alert === second) {
                                const latStr = lat.toFixed(6);
                                const lonStr = lon.toFixed(6);
                                const labelHtml = `
              DERNI√àRE ALERTE<br>${formatted}<br>
              <span style="border:1px white solid;padding:4px;">
                <span style="font-size:11px; color:white; padding:8px">${latStr}, ${lonStr}</span>
                <button class="copy-btn">‚éò</button>
              </span>`;

                                const label = L.divIcon({
                                    className: 'alert-label',
                                    html: `<div style="
                font-family: 'Karla-Cedille';
                background: rgba(255,0,0,0.9);
                border-radius: 6px;
                padding: 4px 6px;
                font-size: 1.1em;
                color: #fff;
                text-align: center;
                box-shadow: 0 0 4px rgba(0,0,0,0.2);
              ">${labelHtml}</div>`,
                                    iconSize: [210, 60],
                                    iconAnchor: [105, 50]
                                });

                                const offset = alert === latest ? 0.0016 : 0.001;
                                const marker = L.marker([lat + offset, lon], { icon: label }).addTo(map);

                                marker.on('click', () => {
                                    navigator.clipboard.writeText(`${latStr},${lonStr}`);
                                    window.showCopyMessage();
                                });
                            } else {
                                // Non-latest alerts: popup with date and copy button
                                const latStr = lat.toFixed(6);
                                const lonStr = lon.toFixed(6);
                                const popupContent = `
            Date de l'alerte : <b>${formatted}</b><br><br>
            <span style="border: 1px black solid; padding: 5px">Coordonn√©es : ${latStr}, ${lonStr}
            <button class="copy-btn" style="color:black" onclick="navigator.clipboard.writeText('${latStr},${lonStr}'); window.showCopyMessage();">‚éò</button></span>
        `;
                                const alertCircle = L.circle([lat, lon], {
                                    radius: circleRadius,
                                    color: color,
                                    weight: 1.5,
                                    opacity: 0,
                                    fill: true,
                                    fillColor: color,
                                    fillOpacity: 0,
                                    interactive: true
                                }).addTo(map);

                                alertCircle.bindPopup(popupContent);

                            }
                        });

                        if (latest?.geom?.coordinates) {
                            const [lon, lat] = latest.geom.coordinates;
                            map.setView([lat, lon], 14);
                        }
                    }

                    renderAlerts(allAlerts);

                    // -----------------------------
                    // 4Ô∏è‚É£ Filter Logic
                    // -----------------------------
                    const applyBtn = document.getElementById('apply-filter');
                    applyBtn.addEventListener('click', () => {
                        const start = new Date(fpStart.selectedDates[0]);
                        const end = new Date(fpEnd.selectedDates[0]);
                        const filtered = allAlerts.filter(a => {
                            const d = new Date(a.alert_date);
                            return d >= start && d <= end;
                        });
                        renderAlerts(filtered);

                        if (filtered.length > 0) {
                            const bounds = L.latLngBounds(
                                filtered.map(a => [a.geom.coordinates[1], a.geom.coordinates[0]])
                            );
                            map.fitBounds(bounds, { padding: [50, 50] });
                        }
                    });

                } catch (err) {
                    console.error('‚ùå Error initializing map:', err);
                }
            };
        })();
    </script>
</body>

</html>